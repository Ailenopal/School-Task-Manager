<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Task Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for task list */
        #taskListContainer::-webkit-scrollbar {
            width: 8px;
        }
        #taskListContainer::-webkit-scrollbar-thumb {
            background-color: #a8a29e;
            border-radius: 4px;
        }
        #taskListContainer::-webkit-scrollbar-track {
            background-color: #f5f5f5;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'accent': '#f59e0b',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10 p-6 bg-white shadow-lg rounded-2xl">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">
                ðŸ“š School Task Manager
            </h1>
            <p id="authStatus" class="mt-2 text-sm text-gray-500">Initializing connection...</p>
            <p id="userIdDisplay" class="mt-1 text-xs text-gray-400 truncate"></p>
        </header>

        <!-- Task Input Form -->
        <div class="bg-white p-6 shadow-xl rounded-2xl mb-10">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Add New Assignment</h2>
            <form id="taskForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Subject -->
                    <input type="text" id="subject" placeholder="Subject (e.g., Math, History)" required
                           class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">

                    <!-- Teacher -->
                    <input type="text" id="teacher" placeholder="Teacher's Name" required
                           class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">

                    <!-- Due Date -->
                    <input type="date" id="dueDate" required
                           class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">

                    <!-- Day (Readonly/Display, calculated by JS) -->
                    <input type="text" id="dueDay" placeholder="Day (Auto-calculated)" readonly
                           class="p-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed">
                </div>

                <!-- Task Description -->
                <textarea id="description" placeholder="Task Description (e.g., Read Chapter 5 and summarize)" required
                          rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 resize-none"></textarea>

                <!-- Add Button -->
                <button type="submit" id="addTaskButton"
                        class="w-full md:w-auto px-6 py-3 bg-primary text-white font-bold rounded-lg shadow-md hover:bg-indigo-600 transition duration-300 ease-in-out transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-primary/50 disabled:opacity-50">
                    Add Task
                </button>
            </form>
        </div>

        <!-- Task List -->
        <div class="bg-white p-6 shadow-xl rounded-2xl">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Assignments Due</h2>
            <div id="taskListContainer" class="max-h-[60vh] overflow-y-auto pr-2">
                <div id="taskList" class="space-y-3">
                    <!-- Tasks will be injected here by JavaScript -->
                    <p id="loadingMessage" class="text-center text-gray-500">Loading tasks...</p>
                </div>
            </div>
        </div>

        <!-- Message/Error Box -->
        <div id="messageBox" class="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-lg hidden"></div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, serverTimestamp, updateDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level (optional, but good for debugging)
        setLogLevel('Debug');
        
        // --- GLOBAL VARIABLES & INITIALIZATION ---
        // Access global variables provided by the environment safely
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        const authStatusEl = document.getElementById('authStatus');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const taskForm = document.getElementById('taskForm');
        const taskListEl = document.getElementById('taskList');
        const dueDateInput = document.getElementById('dueDate');
        const dueDayInput = document.getElementById('dueDay');
        const addTaskButton = document.getElementById('addTaskButton');

        // Helper function to display temporary messages (instead of alert)
        function showMessage(text, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.className = `fixed bottom-4 right-4 text-white p-3 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'} block opacity-100`;

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        }

        // Function to determine the collection path for private user data
        function getUserTasksCollectionRef() {
            if (!db || !userId) return null;
            // Use the locally defined 'appId' variable
            return collection(db, `artifacts/${appId}/users/${userId}/tasks`);
        }

        // --- AUTHENTICATION & INITIALIZATION ---
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    authStatusEl.textContent = "Error: Firebase configuration is missing.";
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set persistence to keep the user signed in (optional)
                await setPersistence(auth, browserLocalPersistence);

                authStatusEl.textContent = "Connecting...";

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = `User ID: ${userId}`;
                        authStatusEl.textContent = "Connected. Ready to manage tasks.";
                        isAuthReady = true;
                        // Start listening to tasks only after successful authentication
                        setupTaskListener();
                    } else {
                        // Attempt silent authentication using the locally defined 'initialAuthToken'
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Fallback to anonymous sign-in
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization/Auth Error:", error);
                authStatusEl.textContent = `Authentication failed: ${error.message}`;
            }
        }

        // --- REAL-TIME DATA LISTENER (CRUD Read) ---
        function setupTaskListener() {
            const tasksRef = getUserTasksCollectionRef();
            if (!tasksRef) return;
            
            // Note: We avoid orderBy in the query to prevent needing custom indexes,
            // and instead sort the data client-side after fetching.
            const q = query(tasksRef); 

            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach((doc) => {
                    // Use a safe data structure for the task object
                    const data = doc.data();
                    tasks.push({
                        id: doc.id,
                        subject: data.subject || 'N/A',
                        teacher: data.teacher || 'N/A',
                        description: data.description || 'No description',
                        dueDate: data.dueDate ? data.dueDate.toDate() : new Date(), // Convert Firestore Timestamp to Date
                        isCompleted: !!data.isCompleted,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                    });
                });
                
                // Sort tasks: Incomplete tasks first, then by earliest due date.
                tasks.sort((a, b) => {
                    if (a.isCompleted !== b.isCompleted) {
                        return a.isCompleted ? 1 : -1; // Incomplete tasks first
                    }
                    return a.dueDate - b.dueDate; // Then by due date (ascending)
                });
                
                renderTasks(tasks);
            }, (error) => {
                console.error("Error listening to tasks:", error);
                showMessage("Failed to load tasks.", true);
            });
        }

        // --- TASK RENDERING ---
        function renderTasks(tasks) {
            taskListEl.innerHTML = ''; // Clear existing tasks

            if (tasks.length === 0) {
                taskListEl.innerHTML = `<p class="text-center text-gray-500 p-4">No assignments yet! Add a new task above.</p>`;
                return;
            }

            tasks.forEach(task => {
                const dayOfWeek = task.dueDate.toLocaleDateString('en-US', { weekday: 'short' });
                const formattedDate = task.dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                // Enhanced Styling Logic
                let cardClass, textDecoration, dateBadgeClass;
                
                if (task.isCompleted) {
                    // Completed style: Faded, gray background, subtle ring
                    cardClass = 'bg-gray-100 ring-1 ring-gray-300 opacity-80';
                    textDecoration = 'line-through text-gray-400';
                    dateBadgeClass = 'bg-green-200 text-green-800';
                } else {
                    // Incomplete style: White background, primary color ring, more prominent shadow
                    cardClass = 'bg-white ring-2 ring-primary shadow-lg hover:shadow-xl';
                    textDecoration = 'text-gray-800';
                    dateBadgeClass = 'bg-primary text-white';
                }


                const taskElement = document.createElement('div');
                // Apply common classes plus the state-specific cardClass and hover effect
                taskElement.className = `flex items-center justify-between p-4 rounded-xl transition duration-300 transform hover:scale-[1.005] ${cardClass}`;
                
                taskElement.innerHTML = `
                    <div class="flex items-start flex-grow min-w-0">
                        <!-- Checkbox and Task Details -->
                        <input type="checkbox" data-id="${task.id}" ${task.isCompleted ? 'checked' : ''} 
                               class="h-5 w-5 mr-4 mt-1 text-primary border-gray-300 rounded focus:ring-primary cursor-pointer"
                               onchange="toggleCompletion('${task.id}', this.checked)">
                        
                        <div class="flex-grow min-w-0">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3 mb-1">
                                <!-- Subject & Teacher -->
                                <span class="font-bold text-lg ${textDecoration} truncate">${task.subject}</span>
                                <span class="text-sm text-gray-500 truncate mt-1 sm:mt-0">/ ${task.teacher}</span>
                            </div>
                            <!-- Description -->
                            <p class="text-sm ${textDecoration} text-gray-600 mt-1 pr-2">${task.description}</p>
                        </div>
                    </div>

                    <!-- Due Date & Actions -->
                    <div class="flex-shrink-0 ml-4 flex flex-col items-end space-y-2">
                        <!-- Date Badge -->
                        <div class="text-xs font-semibold px-3 py-1 rounded-full ${dateBadgeClass} whitespace-nowrap shadow-sm">
                            ${dayOfWeek}, ${formattedDate}
                        </div>
                        
                        <!-- Delete Button -->
                        <button onclick="deleteTask('${task.id}')" title="Delete Task"
                                class="text-gray-400 hover:text-red-500 p-1 rounded-full transition duration-150 transform hover:scale-110">
                            <!-- Icon: Trash -->
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                taskListEl.appendChild(taskElement);
            });
        }
        
        // --- INPUT HANDLER: Calculate Day of Week ---
        dueDateInput.addEventListener('change', (e) => {
            if (e.target.value) {
                const date = new Date(e.target.value + 'T00:00:00'); // Use T00:00:00 to prevent timezone issues
                dueDayInput.value = date.toLocaleDateString('en-US', { weekday: 'long' });
            } else {
                dueDayInput.value = '';
            }
        });


        // --- CRUD Create ---
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) {
                showMessage("Authentication not complete. Please wait.", true);
                return;
            }
            addTaskButton.disabled = true;
            addTaskButton.textContent = 'Adding...';

            const subject = document.getElementById('subject').value.trim();
            const teacher = document.getElementById('teacher').value.trim();
            const dueDateValue = document.getElementById('dueDate').value; // YYYY-MM-DD
            const description = document.getElementById('description').value.trim();
            
            if (!subject || !teacher || !dueDateValue || !description) {
                showMessage("All fields are required.", true);
                addTaskButton.disabled = false;
                addTaskButton.textContent = 'Add Task';
                return;
            }

            try {
                const tasksRef = getUserTasksCollectionRef();
                if (!tasksRef) throw new Error("Database reference not ready.");

                // Due date is stored as a standard ISO date string to avoid timezone issues on retrieval
                await addDoc(tasksRef, {
                    subject,
                    teacher,
                    dueDate: new Date(dueDateValue + 'T00:00:00'), // Store as Firebase Timestamp
                    description,
                    isCompleted: false,
                    createdAt: serverTimestamp()
                });

                showMessage("Task added successfully!");
                taskForm.reset();
                dueDayInput.value = ''; // Manually clear readonly field

            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage("Failed to add task: " + error.message, true);
            } finally {
                addTaskButton.disabled = false;
                addTaskButton.textContent = 'Add Task';
            }
        });

        // --- CRUD Update ---
        window.toggleCompletion = async function (taskId, isCompleted) {
            if (!isAuthReady) {
                showMessage("Authentication not complete. Please wait.", true);
                return;
            }
            try {
                const tasksRef = getUserTasksCollectionRef();
                if (!tasksRef) throw new Error("Database reference not ready.");
                
                const taskDocRef = doc(tasksRef, taskId);
                await updateDoc(taskDocRef, {
                    isCompleted: isCompleted
                });

            } catch (error) {
                console.error("Error updating document: ", error);
                showMessage("Failed to update task.", true);
                // Revert checkbox state on failure
                document.querySelector(`input[data-id="${taskId}"]`).checked = !isCompleted;
            }
        }

        // --- CRUD Delete ---
        window.deleteTask = async function (taskId) {
            if (!isAuthReady) {
                showMessage("Authentication not complete. Please wait.", true);
                return;
            }
            // Simple visual feedback that delete is in progress
            const taskEl = document.querySelector(`button[onclick="deleteTask('${taskId}')"]`).closest('div.flex');
            taskEl.style.opacity = 0.5; 
            
            try {
                const tasksRef = getUserTasksCollectionRef();
                if (!tasksRef) throw new Error("Database reference not ready.");
                
                const taskDocRef = doc(tasksRef, taskId);
                await deleteDoc(taskDocRef);
                showMessage("Task deleted.");

            } catch (error) {
                console.error("Error deleting document: ", error);
                showMessage("Failed to delete task.", true);
                taskEl.style.opacity = 1; // Revert visual state on failure
            }
        }

        // Start the application
        initializeFirebase();

    </script>
    
    <!-- Load Inter font for better typography -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
</body>
</html>
